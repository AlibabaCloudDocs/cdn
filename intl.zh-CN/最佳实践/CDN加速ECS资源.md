# CDN加速ECS资源

使用阿里云CDN可实现对ECS上静态资源的加速。当用户访问ECS上的资源时，动态资源的请求由ECS直接返回给用户，静态资源可缓存到CDN遍布全球的加速节点，供用户接近访问，实现资源访问加速。通过本文您可以详细了解CDN加速ECS的应用场景，以及通过CDN控制台实现CDN加速ECS的操作方法。

执行本文操作之前，请确保您已完成阿里云[账号注册](https://account.alibabacloud.com/register/intl_register.htm)和[实名认证](https://account-intl.console.aliyun.com/#/intlAuth)。

阿里云CDN配合精准的调度系统，将您对静态资源的请求分配至最近节点，使您以最快的速度读取到所需的资源，有效解决网络拥塞问题，提高资源的访问响应速度。

ECS上存储的动态资源包括Web程序和数据库，静态资源包括静态脚本、图片、附件、音频和视频。当ECS作为源站，您请求访问或下载资源时，ECS上的动态资源将直接返回给您；ECS上的静态资源可以通过CDN加速实现请求加速，将源站上的资源缓存到CDN的加速节点，系统自动调用距离您最近的CDN节点上已缓存的资源。CDN加速ECS的架构图如下所示。

**说明：** 如果您需要加速ECS上的动态资源，可以使用阿里云全站加速产品。相关介绍，请参见[什么是全站加速]()。

![应用场景](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0211008951/p51266.png)

ECS作为CDN的源站，通过CDN加速分发，并通过CDN节点就近获得资源，架构优势如下：

-   用户访问网站资源，全部通过CDN，降低源站压力。
-   使用CDN流量，单价低于ECS直接访问外网流量。
-   从距离客户端最近的CDN节点获取资源，减少网络传输距离，保证静态资源传输质量。

1.  在CDN控制台上，添加ECS域名。

    1.  登录[CDN控制台](https://cdn.console.aliyun.com)。

    2.  在左侧导航栏，单击**域名管理**。

    3.  在**域名管理**页面，单击**添加域名**。

    4.  在**添加域名**页面，完成以下配置。

        **第一部分：配置基础信息**

        ![intl](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4273212261/p94747.png)

        |参数|说明|
        |--|--|
        |**加速域名**|注意事项如下：

        -   加速域名一般使用子域名或泛域名，且仅支持全英文小写的域名，不支持中文域名加速。

示例：您的域名是`example.com`，加速域名可以是`example.com`的子域名，例如`cdntest.example.com`。

        -   支持泛域名加速，例如`*.example.com`。泛域名加速规则，请参见[泛域名加速规则]()。

**说明：**

            -   泛域名和子域名必须在同一个账号下。您添加域名时CDN会进行检查，如果泛域名或子域名被添加到不同账号，系统会报错。如果您无法自行解决，请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.2020520001.aliyun_topbar.18.dbd44bd3e4f845#/ticket/createIndex)处理。
            -   如果泛域名未被添加到任何CDN账号下，则支持在多个账号下添加不同的子域名。
        -   加速域名不允许重复添加。

如果出现**域名已添加**的提示，请检查您的域名是否已经添加到其他云产品中，例如视频点播、视频直播、全站加速、SCDN和视频监控，您也可以[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.2020520001.aliyun_topbar.18.dbd44bd3e4f845#/ticket/createIndex)处理。

        -   每个阿里云账号最多可以添加50个加速域名。

如果您域名的总带宽日均峰值大于50 Mbps，且业务无风险，可[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.2020520001.aliyun_topbar.18.dbd44bd3e4f845#/ticket/createIndex)申请增加域名个数。

        -   加速内容必须合法且符合CDN业务规范。详细信息，请参见[使用限制](/intl.zh-CN/产品简介/使用限制.md)。 |
        |**业务类型**|        -   [图片小文件](/intl.zh-CN/产品简介/应用场景/图片小文件.md)：适用于电商类、网站类、游戏图片类等小型的静态资源加速场景。
        -   [大文件下载](/intl.zh-CN/产品简介/应用场景/大文件下载.md)：适用于大于20 MB的静态文件加速场景。
        -   [视音频点播](/intl.zh-CN/产品简介/应用场景/视音频点播.md)：适用于音频或视频文件加速场景。
        -   [全站加速](/intl.zh-CN/产品简介/应用场景/全站加速.md)：适用于含有大量动静态内容混合，且多为动态资源请求的加速场景。

当业务类型选择为**全站加速**时，您需根据界面提示前往全站加速控制台添加域名并进行相关配置。具体操作，请参见[添加加速域名]()。 |
        |**加速区域**|选择加速区域。加速区域为**仅中国内地**或**全球**时，加速域名必须备案，您可以登录[阿里云ICP代备案管理系统](https://beian.aliyun.com/pcContainer/myorder)完成备案。由于工信部备案系统存在数据延迟，刚完成备案的域名请在8小时后再配置。

**说明：** 不同的加速区域价格不一样，请根据您的实际需求选择。计费详情，请参见[CDN定价](https://www.alibabacloud.com/zh/product/cdn/pricing)。

        -   **仅中国内地**：全球用户访问均会调度至中国内地加速节点进行服务。
        -   **全球**：全球用户访问将会择优调度至最近的加速节点进行服务。
        -   **全球（不包含中国内地）**：全球用户访问均会调度至中国香港、中国澳门、中国台湾以及其他国家和地区的加速节点进行服务。 |

        **第二部分：配置源站信息**

        ![配置源站信息](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1561212261/p278368.png)

        |参数|说明|
        |--|--|
        |**源站信息**|选择**IP**或**源站域名**。        -   **IP**：填写您的服务器外网IP，支持多个服务器外网IP。
        -   **源站域名**：填写您的源站域名，支持多个源站域名。

**说明：** 源站域名不能与加速域名相同，否则会造成循环解析，无法回源。 |
        |**优先级**|源站优先级支持设置主备，主优先级大于备优先级。用户请求通过阿里云CDN回源时，会优先回源到优先级为主的源站地址。

例如，有A、B两个源站，A源站的优先级为主，B源站的优先级为备，则用户请求通过阿里云CDN回源时会优先回源到A源站，如果A源站出现故障，将会回源到B源站，当A源站恢复正常后会从B源站切换回A源站。 |
        |**权重**|当多个源站的优先级相同时，阿里云CDN会按照源站的权重分配用户请求回源到不同源站的比例，实现按权重的负载均衡。权重的取值范围是1~100，数值越大，源站分配到的用户请求比例越高。

例如，有A、B两个源站，两个源站的优先级都是主，A源站的权重为80，B源站的权重为20，则用户请求将会按照8:2的比例在A、B两个源站之间分配。 |
        |**端口**|根据您源站的支持情况，设置回源端口，允许设置的端口范围为1~65535。当前仅支持以HTTP协议回源到自定义端口，如果您需要以HTTPS协议回源到自定义端口，请[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.2020520001.aliyun_topbar.18.dbd44bd3e4f845#/ticket/createIndex)处理。

        -   如果您配置了自定义端口，需关闭协议跟随回源功能，自定义端口才能生效。关闭回源协议的操作方法，请参见[配置回源协议](/intl.zh-CN/域名管理/回源配置/配置回源协议.md)。
        -   当源站选择OSS域名时，回源端口是否支持自定义端口，取决于OSS产品。 |

    5.  单击**下一步**。

        您首次在CDN控制台添加一个新域名时，需要完成域名归属权验证。如果您之前已经验证通过，请忽略该步骤。具体操作，请参见[验证域名归属权]()。

    6.  等待人工审核。

        审核时间预计需要1~2个工作日，如果您的源站是阿里云ECS或OSS，则审核速度会加快，您也可以[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.2020520001.aliyun_topbar.18.dbd44bd3e4f845#/ticket/createIndex)加急审核。

        加速域名审核通过后，您可以在**域名管理**页面查看，状态显示为**正常运行**，表示添加成功。

2.  在CDN控制台上，获取CNAME。

    1.  登录[CDN控制台](https://cdn.console.aliyun.com)。

    2.  在左侧导航栏，单击**域名管理**。

    3.  在**域名管理**页面，复制加速域名对应的CNAME地址。

        ![域名管理](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9618134161/p66555.png)

3.  在阿里云云解析DNS控制台上，配置CNAME。

    本文以阿里云云解析DNS为例，为您介绍配置CNAME的方法。

    1.  登录[云解析DNS控制台](https://dns.console.aliyun.com)。

    2.  在**域名解析**页面，找到您的域名，在域名右侧单击**解析设置**。

    3.  单击**添加记录**，添加CNAME记录。

        **说明：**

        -   精准域名的CNAME解析优先级大于泛域名的CNAME解析。如果您的加速域名为泛域名，且主机记录设置为星号（\*）时，需删除泛域名下所有已生效的二级域名的解析记录。
        -   添加CNAME记录时如果遇到冲突问题，建议您更换一个加速域名或调整冲突的记录。
        ![添加记录](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5843918061/p64412.png)

        |参数|说明|填写样例|
        |--|--|----|
        |**记录类型**|选择CNAME。|CNAME|
        |**主机记录**|主机记录指加速域名的前缀。|        -   加速域名为`testcdn.aliyun.com`，主机记录为`testcdn`。
        -   加速域名为`www.aliyun.com`，主机记录为`www`。
        -   加速域名为`aliyun.com`，主机记录为`@`。
        -   加速域名为`*.aliyun.com`，主机记录为`*`。 |
        |**解析线路**|默认线路。|保持默认|
        |**记录值**|输入加速域名对应的CNAME地址。

**说明：** 一个加速域名对应一个CNAME地址，二级域名不能使用主域名的CNAME地址。如果您要加速二级域名，需要将二级域名也添加到CDN上并解析到对应的CNAME地址，或者在CDN上添加泛域名，泛域名的CNAME可以被二级域名使用。添加泛域名或二级域名，请参见[添加加速域名](/intl.zh-CN/快速入门/添加加速域名.md)。

|all.example.com.w.kunlunsl.com|
        |**TTL**|TTL为缓存时间，数值越小，修改记录后各地生效时间越快，默认为10分钟。|保持默认|

    4.  单击**确认**，完成添加。

        成功配置CNAME且生效后加速服务会立即生效。新增CNAME记录实时生效，修改CNAME记录在10分钟后生效（具体生效时间长短取决于域名DNS解析配置的TTL时长，10分钟为TTL的默认时长）。成功配置CNAME后状态更新约有10分钟延迟，CDN控制台的域名列表中可能仍显示“未配置CNAME”，请先忽略。

4.  在本地PC机上，验证CNAME配置是否生效。

    1.  打开Windows操作系统中的cmd程序。

    2.  在命令行中ping加速域名，如果返回的解析结果和CDN控制台上该加速域名的CNAME值一致，则表示CDN加速已经生效。

        ![CNAME生效验证](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9618134161/p66693.png)


